# LOCAL TEST GUIDE - Exact Commands for Your Repo

**Path:** `c:\Users\Donte\Downloads\Primus insights roofing\PrimusInsightsRoofing`

Follow these exact commands to test Primus Home Pro locally before deploying.

---

## ‚úÖ Step 1: Create .env.local (5 minutes)

Create this file in the `frontend` folder:

**Path:** `c:\Users\Donte\Downloads\Primus insights roofing\PrimusInsightsRoofing\frontend\.env.local`

```env
# ============================================================================
# DATABASE - Local Postgres
# ============================================================================
# Option A: Local Postgres
DATABASE_URL="postgresql://postgres:password@localhost:5432/primus_local"

# Option B: Vercel Postgres (if you already have it)
# DATABASE_URL="postgresql://..."

# ============================================================================
# CLERK AUTHENTICATION (Test Keys)
# ============================================================================
# Get from: https://dashboard.clerk.com (use test environment)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY="pk_test_..."
CLERK_SECRET_KEY="sk_test_..."
CLERK_WEBHOOK_SECRET="whsec_..."

# ============================================================================
# ANTHROPIC AI
# ============================================================================
ANTHROPIC_API_KEY="sk-ant-..."

# ============================================================================
# STRIPE (Test Mode Keys)
# ============================================================================
# Get from: https://dashboard.stripe.com/test/apikeys
STRIPE_SECRET_KEY="sk_test_..."
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_..."

# This will be generated by stripe listen command below
STRIPE_WEBHOOK_SECRET="whsec_..."

# Stripe Price IDs (already configured in plans.ts)
STRIPE_PRICE_PRO="price_1SZ1ii05lmCbSdUDS1cX1OW8"
STRIPE_PRICE_AGENCY="price_1SZ1l005lmCbSdUDzc20PR2E"

# ============================================================================
# APPLICATION
# ============================================================================
NEXT_PUBLIC_APP_URL="http://localhost:3000"

# ============================================================================
# CRON SECURITY
# ============================================================================
CRON_SECRET="local-test-secret-123"

# ============================================================================
# OPTIONAL: Email/SMS (can use stubs for now)
# ============================================================================
# TWILIO_ACCOUNT_SID="AC..."
# TWILIO_AUTH_TOKEN="..."
# TWILIO_PHONE_NUMBER="+1..."
# RESEND_API_KEY="re_..."
```

---

## ‚úÖ Step 2: Set Up Local Database (10 minutes)

### Option A: Docker (Recommended - Easiest)

Open PowerShell/Command Prompt and run:

```powershell
# Start local Postgres container
docker run --name primus-postgres `
  -e POSTGRES_PASSWORD=password `
  -e POSTGRES_DB=primus_local `
  -p 5432:5432 `
  -d postgres:15

# Verify it's running
docker ps
```

**Your DATABASE_URL:** `postgresql://postgres:password@localhost:5432/primus_local`

### Option B: Windows PostgreSQL Installation

1. Download from: https://www.postgresql.org/download/windows/
2. Install with default settings
3. During install, set password (e.g., `password`)
4. Create database:
   ```sql
   CREATE DATABASE primus_local;
   ```

---

## ‚úÖ Step 3: Install Dependencies (2 minutes)

```powershell
cd "c:\Users\Donte\Downloads\Primus insights roofing\PrimusInsightsRoofing\frontend"
npm install
```

---

## ‚úÖ Step 4: Run Database Migration (2 minutes)

```powershell
# Still in frontend folder
npx prisma generate
npx prisma migrate dev --name init_local
```

**Expected output:**
```
‚úî Generated Prisma Client
‚úî Applied migration init_local
```

---

## ‚úÖ Step 5: Seed Default Automations (1 minute)

**IMPORTANT:** You need at least one user in the database first. We'll create it via sign-up in Step 7.

For now, just verify the seed file exists:

```powershell
ls prisma/seed-automations.ts
```

---

## ‚úÖ Step 6: Start Stripe Webhook Listener (New Terminal)

Open a **second** PowerShell/Command Prompt window:

```powershell
# If you haven't installed Stripe CLI yet:
# Download from: https://github.com/stripe/stripe-cli/releases/latest
# Or use: winget install stripe.stripe-cli

# Login to Stripe
stripe login

# Forward webhooks to local server
stripe listen --forward-to localhost:3000/api/webhooks/stripe
```

**Copy the webhook secret** that appears (starts with `whsec_...`) and add it to your `.env.local`:

```env
STRIPE_WEBHOOK_SECRET="whsec_..."
```

**Keep this terminal running!**

---

## ‚úÖ Step 7: Start Dev Server (3 minutes)

In your **first** terminal (still in frontend folder):

```powershell
npm run dev
```

**Expected output:**
```
‚ñ≤ Next.js 14.2.33
- Local:        http://localhost:3000
‚úì Ready in 2.5s
```

---

## ‚úÖ Step 8: Test Full Flow (15 minutes)

### Test 1: User Sign-Up

1. Visit: http://localhost:3000
2. Click "Sign In" or visit http://localhost:3000/sign-up
3. Create account with your email
4. **Expected:** Redirected to `/dashboard`

**Verify in database:**
```powershell
# In another terminal
cd "c:\Users\Donte\Downloads\Primus insights roofing\PrimusInsightsRoofing\frontend"
npx prisma studio
```
- Open browser to http://localhost:5555
- Check `User` table ‚Üí Your user should exist
- Note your `id` (e.g., `user_abc123`)

### Test 2: Seed Automations

Now that you have a user, seed automations:

```powershell
npx ts-node prisma/seed-automations.ts
```

**Expected output:**
```
Using user: your@email.com
‚úì Created: Welcome New Leads
‚úì Created: Follow-up Stale Leads
‚úì Created: High Intent - Send Calendar
‚úÖ Default automations seeded successfully!
```

### Test 3: Lead Capture

1. Visit: http://localhost:3000/templates/simple
2. Fill in form:
   - Name: `Test Lead`
   - Email: `test@example.com`
   - Phone: `555-123-4567`
   - Message: `I need a new roof urgently`
3. Submit

**Check terminal logs:**
```
‚úì Lead created: lead_xyz | Score: 75 | Intent: Booking
[AUTO] Running automations for trigger: lead.created
[AUTO] Found 2 automation(s)
[AUTO] ‚úì Sent sms via automation "Welcome New Leads"
```

**Verify in Prisma Studio:**
- Check `Lead` table ‚Üí New lead should exist
- Check `LeadEvent` table ‚Üí Should have FORM_SUBMIT, AI_ANALYSIS events

### Test 4: CRM Dashboard

1. Visit: http://localhost:3000/dashboard/leads
2. Click on your test lead
3. **Expected:** LeadDrawer opens with:
   - Lead score badge
   - Intent badge
   - Timeline events
   - AI Action Panel

### Test 5: AI Reply Generation

In the LeadDrawer:

1. Select channel: **Email** or **SMS**
2. Click **Generate Draft**
3. **Expected:** AI-generated reply appears in textarea
4. Click **Send** (will use stub - won't actually send)

**Check terminal logs:**
```
[AI] Generating reply for lead_xyz (channel: email, tone: default)
[AI] ‚úì Draft generated
```

### Test 6: Automation UI

1. Visit: http://localhost:3000/dashboard/automations
2. **Expected:** See 3 default automations
3. Click **Edit** on "Welcome New Leads"
4. Change score slider
5. Click **Save Changes**
6. **Expected:** Settings updated, redirect back to list

### Test 7: Billing Flow (Critical!)

1. Visit: http://localhost:3000/dashboard/billing
2. **Expected:** See 3 plans (Free, Pro, Agency)
3. Click **Upgrade** on Pro plan
4. **Expected:** Redirected to Stripe Checkout

**In Stripe Checkout:**
- Email: Will pre-fill with your account email
- Card: Use test card `4242 4242 4242 4242`
- Expiry: Any future date (e.g., `12/25`)
- CVC: Any 3 digits (e.g., `123`)
- Billing name: Any name

5. Click **Subscribe**

**Check webhook terminal:**
```
Received event: checkout.session.completed
[Webhook] checkout.session.completed
‚úì Subscription activated for user user_abc123
```

**Verify in Prisma Studio:**
- Refresh `User` table
- Your user should now have:
  - `subscriptionPlan`: `"pro"`
  - `subscriptionStatus`: `"active"`
  - `subscriptionCurrentEnd`: Future date

6. Visit http://localhost:3000/dashboard/billing again
7. **Expected:**
   - "CURRENT" badge on Pro plan
   - Shows renewal date
   - Button changed to "Manage Subscription"

### Test 8: Subscription Management

1. Click **Manage Subscription**
2. **Expected:** Redirected to Stripe Customer Portal
3. Try:
   - Update payment method (add another test card)
   - View invoices
   - **Cancel subscription** (test this!)

**After cancellation:**
- Check webhook terminal:
  ```
  Received event: customer.subscription.deleted
  ‚úì Subscription canceled for user user_abc123
  ```
- Verify in Prisma Studio:
  - `subscriptionPlan`: `"free"`
  - `subscriptionStatus`: `"canceled"`

---

## ‚úÖ Step 9: Test Cron Job (5 minutes)

Create a stale lead (older than 3 days):

```powershell
# In Prisma Studio or direct SQL:
# Update a lead's updatedAt to 4 days ago
```

Or manually trigger:

```powershell
# In PowerShell
curl http://localhost:3000/api/cron/process `
  -H "Authorization: Bearer local-test-secret-123"
```

**Expected response:**
```json
{
  "success": true,
  "processed": 1,
  "total": 1,
  "timestamp": "2024-11-29T..."
}
```

---

## ‚úÖ Common Issues & Fixes

### Issue: `npx prisma migrate` fails

**Error:** `Can't reach database server`

**Fix:**
1. Verify Docker container is running: `docker ps`
2. Check DATABASE_URL in `.env.local`
3. Restart container: `docker restart primus-postgres`

### Issue: Stripe checkout doesn't redirect

**Error:** Session created but no redirect

**Fix:**
1. Check `NEXT_PUBLIC_APP_URL` is set to `http://localhost:3000`
2. Verify `STRIPE_SECRET_KEY` starts with `sk_test_`
3. Check browser console for errors

### Issue: Webhooks not received

**Error:** No logs in webhook terminal

**Fix:**
1. Ensure `stripe listen` is running
2. Copy the `whsec_...` to `.env.local`
3. Restart dev server after updating env

### Issue: AI generation fails

**Error:** `Error generating reply`

**Fix:**
1. Verify `ANTHROPIC_API_KEY` is valid
2. Check terminal logs for specific error
3. Try with different tone/channel

---

## ‚úÖ Success Criteria

All tests passed if you can:

- [x] Sign up and see dashboard
- [x] Submit lead and see it in CRM
- [x] See AI analysis in lead events
- [x] Generate AI reply draft
- [x] Edit automation settings
- [x] Complete Stripe checkout (test mode)
- [x] See subscription updated in database
- [x] Cancel subscription successfully
- [x] Trigger cron job manually

---

## üéØ Next Step After Local Tests Pass

Once all tests pass locally, you're ready to deploy to production!

**Command to proceed:**

Say: **"Local tests passed, let's deploy to Vercel"**

I'll give you the exact Vercel deployment checklist with:
- Environment variables list
- Database setup commands
- Production webhook configuration
- Go-live checklist

---

## üìù Notes

**Terminal Layout:**
- Terminal 1: Dev server (`npm run dev`)
- Terminal 2: Stripe webhook listener (`stripe listen`)
- Terminal 3: Commands (Prisma Studio, curl tests, etc.)

**Database Access:**
- Prisma Studio: `npx prisma studio` ‚Üí http://localhost:5555
- Direct SQL: Use pgAdmin or any Postgres client

**Logs to Watch:**
- Next.js server logs (Terminal 1)
- Stripe webhook events (Terminal 2)
- Browser console (F12 in browser)

---

**Ready to start? Copy the commands above and execute step-by-step. Report back if any step fails!** üöÄ
